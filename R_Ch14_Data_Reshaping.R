### 14 ???????????? Data Reshaping

## 14-1 cbind???rbind????????????

# ????????????????????????????????????????????????????????????
# ????????????rbind???cbind?????????????????????

# ????????????vector,???????????????data.frame????????????????????????
sport <- c("Hockey", "Baseball", "Football")
league <- c("NHL", "MLB", "NFL")
trophy <- c("Stanley Cup", "Commissioner's Trophy", "Vince Lombardi Trophy")
trophiesl <- cbind(sport, league, trophy)

# ??????data.frame()??????????????? data.frame
trophies2 <- data.frame(sport = c("Basketball", "Golf"), league=c("NBA", "PGA"), trophy=c("Larry O'Brien Championship Trophy", "Wanamaker Trophy"),stringsAsFactors = FALSE)

# ?????????rbind???????????????data.frame
trophies <- rbind(trophiesl, trophies2)
head(trophies)

# ???????????????cbind??????????????????????????????
cbind(Sport = sport, Association = league, Prize = trophy)

## 14-2 ????????????

# ?????????????????????????????????,??????????????????cbind?????????,?????????????????????????????????
# ?????????????????????merge?????????plyr?????????join?????????data.table??????????????????

# ??????USAID?????????
# ??????????????????,???unzip????????????data12?????????
download.file(url = "https://www.jaredlander.com/data/US_Foreign_Aid.zip", destfile="ForeignAid.zip")
unzip("ForeignAid.zip", exdir = "data12")

# ??????8?????????,??????for???????????????
# ??????dir?????????????????????,??????????????????????????????
# ?????????assign?????????????????????????????????
# str_sub?????????????????????character vector??????????????????character

library(stringr)

theFiles <- dir("data12/", pattern = "\\.csv") #?????????????????????
for(a in theFiles){
  #????????????????????????????????????,strsub(?????????????????????,???12~18????????????)
  nameToUse <- str_sub(string = a, start = 12, end = 18) 
  #??????read.table??????csv???
  #???file.path???????????????????????????
  temp <- read.table(file = file.path("data12", a),
                     header = TRUE, sep = ",",
                     stringsAsFactors = FALSE)
  #????????????????????????
  assign(x=nameToUse, value = temp)
}

# 14-2-1 ???merge????????????data.frame
Aid90s00s <- merge(x = Aid_90s, y = Aid_00s,
                   by.x = c("Country.Name", "Program.Name"),
                   by.y = c("Country.Name", "Program.Name"))
head(Aid90s00s)
# ?????? by.x ??????????????????data.frame??????????????????????????????
#  by.y ??????????????????data.frame??????????????????????????????
# merge???????????????????????????data.frame???????????????????????????????????????
# ??????????????????????????????????????????????????????


# 14-2-2 ??? plyr ????????? join ??????????????? data.frame
# ???????????????????????????,??????????????????????????????????????????
# ??????????????????????????????????????????
library(plyr)
Aid90s00sJoin <- join( x = Aid_90s, y = Aid_00s,
                       by = c("Country.Name", "Program.Name"))
head(Aid90s00sJoin)

# join??????????????????????????????????????????????????????;???????????????(??????)??????

# ?????????????????????8?????????,?????????????????????data.frame
# ??????????????????data.frame????????????list,??????Reduce???????????????
# Reduce()???????????????????????????????????????

# ?????????data.frame?????????
frameNames <- str_sub(string = theFiles, start = 12, end = 18)
# ??????????????????list
frameList <- vector("list", length(frameNames))
names(frameList) <- frameNames
# ?????????data.frame??????list???
for (a in frameNames) {
  frameList[[a]] <- eval(parse(text = a))
}
# data.frame?????????????????????,??????parse()???????????????,?????????????????????(?????????)
# ??????eval()????????????????????????,????????????????????????
head(frameList[[1]])
head(frameList[[6]])
head(frameList[["Aid_50s"]])

# ?????????data.frame??????list???,????????????list????????????
# ??????????????????????????????,?????????Reduce???????????????
allAid <- Reduce(function(...){
  join(..., by = c("Country.Name", "Program.Name"))
  }, frameList)
dim(allAid)

# ??????useful???????????????????????????
install.packages("useful")
library(useful)
corner(allAid, 15)
bottomleft(allAid, c = 15)

# Reduce??????,???????????????vector 1~10?????????
# ????????????Reduce(sum, 1:10),????????????1???2?????????,????????????3???????????????????????????
# ????????????4??????????????????,??????????????????10??????????????????
# ???Reduce?????????list???????????????data.frame?????????,????????????data.frame???????????????????????????
# ????????????data.frame??????????????????


# 14-2-3 data.table??????????????????

# data.table?????????????????????????????????????????????,????????????????????????????????????
# ?????????????????????????????????data.frame?????????data.tables
library(data.table)
dt90 <- data.table(Aid_90s, key = c("Country.Name", "Program.Name"))
dt00 <- data.table(Aid_00s, key = c("Country.Name", "Program.Name"))
# ???????????????????????????????????????
dt0090 <- dt90[dt00]
# ??????????????????,dt90?????????,dt00?????????,???????????????????????????????????????


## 14-3 ???reshape2 ???????????????????????????

# 14-3-1 melt

# ??????????????????????????????"??????-????????????-??????"???????????????
# ??????????????????????????????(Dollar)?????????????????????????????????
head(Aid_00s)

install.packages("reshape2")
library(reshape2)
melt00 <- melt(Aid_00s, id.vars = c("Country.Name", "Program.Name"), variable.name = "Year", value.name = "Dollars")
tail(melt00, 10)
head(melt00, 10)
# id.vars?????????????????????????????????????????????????????????
# variable.name??????????????????????????????????????????
# value.name????????????????????????????????????????????????????????????

# ?????????
library(scales)
# ??????Year??????????????????"FY"??????,??????????????????numeric
melt00$Year <- as.numeric(str_sub(melt00$Year, start = 3, 6))
# ??????????????????????????????????????????
meltAgg <- aggregate(Dollars ~ Program.Name + Year, data = melt00, FUN = "sum", na.rm = TRUE)
# ?????????????????????????????????????????????
# ????????????????????????????????????????????????
meltAgg$Program.Name <- str_sub(meltAgg$Program.Name, start = 1, end = 10)
library(ggplot2)
ggplot(meltAgg, aes(x = Year, y = Dollars)) + 
  geom_line(aes(group = Program.Name)) +
  facet_wrap(~ Program.Name) +
  scale_x_continuous(breaks = seq(from = 2000, to = 2009, by = 2)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust = 0)) +
  scale_y_continuous(labels = multiple_format(extra = dollar, multiple = "B"))

# 14-3-2 dcast

# ??????????????????????????????????????????????????????,????????????dcast??????
# dcast????????????????????????,????????????????????????????????????
# ???????????????formula,???????????????????????????,?????????????????????????????????
# ????????????????????????????????????????????????????????????

cast00 <- dcast(melt00, Country.Name + Program.Name ~ Year,
                value.var = "Dollars")
head(cast00)
